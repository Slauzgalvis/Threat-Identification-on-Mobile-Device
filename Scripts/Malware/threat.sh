#!/bin/bash
function Decompiling
{
#
clear
cd ../..
DIREKT=${DIREKT///}
echo
echo "***** Decompiling $DIREKT *****"
echo
echo
./dex2jar/d2j-dex2jar.sh Apps/$DIREKT.apk
mv *.jar dex2jarout
java -jar Decompiler/decompiler.jar -jar dex2jarout/*.jar -o Decompiled/$DIREKT
rm dex2jarout/*.jar
cd Decompiled/$DIREKT
}


#MAIN
chmod 777 dex2jar/d2j-dex2jar.sh
chmod 777 dex2jar/d2j_invoke.sh
cd Decompiled
rm analyze.txt
ls -dp * | grep / > appsai.txt
DIREKTORIJOS=`grep -c "^" appsai.txt`

for (( j=1; j <= $DIREKTORIJOS; ++j ))
do 
TIKRINU=0
cd ../Permissions
echo "***** Checking for Dangerous Permissions *****"
EILES=`grep -c "^" Dangerous_Permissions.txt`
	for (( i=1; i <= $EILES; ++i ))
	do   ###
	PERM=`sed -n "${i}p" Dangerous_Permissions.txt`
	cd ../Decompiled
	DIREKT=`sed -n "${j}p" appsai.txt`
	cd `sed -n "${j}p" appsai.txt`
################
		if grep -r "$PERM" permissions.txt; then
		#
			if (($TIKRINU==0)); then
			(Decompiling)
			echo "'`sed -n "${j}p" ../appsai.txt`' Is Using These Dangerous Permissions: " >> ../analyze.txt
			TIKRINU=1
			fi
		#
		echo "$PERM" >> ../analyze.txt
		cd ../../Permissions/Code
		KIEK_KODO=`grep -c "^" $PERM*`
			for (( q=1; q <= $KIEK_KODO; ++q ))
			do
			KODAS=`sed -n "${q}p" $PERM*`
			cd ../../Decompiled
			cd `sed -n "${j}p" appsai.txt`
			grep -r "$KODAS" >> ../analyze.txt
			cd ../../Permissions/Code
			done
		cd ../../Decompiled
		cd `sed -n "${j}p" appsai.txt`
		fi
################
	cd ../../Permissions
	done ###
if (($TIKRINU==0)); then
cd ../Decompiled
rm -rf `sed -n "${j}p" appsai.txt`
cd ../Permissions
fi
cd ../Decompiled
echo >> analyze.txt
done 

#############
sed '/permissions.txt/d' analyze.txt > analyze1.txt
cat analyze1.txt > analyze.txt
rm analyze1.txt
rm appsai.txt










